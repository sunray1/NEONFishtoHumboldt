---
title: "Mapping NEON Fish Data to Humboldt Extension"
author: "Chandra Earl"
date: "`r Sys.Date()`"
output: html_document
---

https://github.com/sunray1/NEONFishtoHumboldt

The following code will download data from Upper Big Creek (BIGC) (wadeable stream) in California during 2019. The goal is to characterize the two sampling efforts (bouts) in Humboldt Extension terms using the 'OBIS hack', where the typical star schema approach of DwC is broken. This will include vouchered specimens (Occurrence), DNA sequences (DNA Derived Data), fish abundance measurements (Measurement or Fact) and event ecological data (Humboldt).

# Load libraries

```{r message=FALSE, warning=FALSE}
setwd("C:/Users/cearl4/Desktop/Labs/ASU/Stuff/Conferences_Workshops/GBIF_Humbolt2024_workshop/NEONFishtoHumboldt")

library(neonUtilities)
library(dplyr)
library(lubridate)
```

# Download files

<https://data.neonscience.org/data-products/DP1.20107.001>

<https://www.neonscience.org/field-sites/bigc>

## Get Fish Count data

```{r}
fish.counts <- loadByProduct(dpID="DP1.20107.001", 
                           site=c("BIGC"),
                           startdate="2019-01", 
                           enddate="2019-12",
                           check.size = F)

#fish.coi <- loadByProduct(dpID="DP1.20105.001", 
#                           site=c("BIGC"),
#                           startdate="2019-01", 
#                           enddate="2019-12")

#water.quality <- loadByProduct(dpID="DP1.20288.001", 
#                           site=c("BIGC"),
#                           startdate="2019-01", 
#                           enddate="2019-12")
```

## Get Other Data

First, we need to get the start and end dates for the data from fish counts, since these data are much more coarse than the environmental data is.

```{r}
events <- ym(unique(format(sort(fish.counts$fsh_fieldData$startDate[order(fish.counts$fsh_fieldData$startDate)]), "%Y-%m")))
fish.counts.coll.date.ranges <- data.frame(start = events[1], 
                                           end = events[1])

for (i in 2:length(events)) {
  # Check if the current date is consecutive with the last date in the range
  if (events[i] == 
      fish.counts.coll.date.ranges$end[nrow(fish.counts.coll.date.ranges)] %m+% months(1)) {
    # Extend the current range if the date is consecutive
    fish.counts.coll.date.ranges$end[nrow(fish.counts.coll.date.ranges)] <- events[i]
  } else {
    # Otherwise, start a new range
    fish.counts.coll.date.ranges <- rbind(fish.counts.coll.date.ranges, data.frame(start = events[i], 
                                                                                   end = events[i]))
  }
}

#Since NEON data are provided in month packages, finer scale querying is not available.
fish.counts.coll.date.ranges <- format(fish.counts.coll.date.ranges, "%Y-%m")

fish.counts.coll.date.ranges
```

Download air temp data

```{r warning=FALSE}
air.temp.SAAT30 <- data.frame()

for (i in 1:nrow(fish.counts.coll.date.ranges)) {
  start_date <- fish.counts.coll.date.ranges$start[i]
  end_date <- fish.counts.coll.date.ranges$end[i]
  
  air.temp <- loadByProduct(dpID = "DP1.00002.001", 
                            site = c("BIGC"), 
                            startdate = start_date, 
                            enddate = end_date,
                            check.size = F,
                            tabl = "SAAT_30min")
  
  air.temp.SAAT30 <- rbind(air.temp.SAAT30, air.temp$SAAT_30min)
  
}
```

# Map Data

## Create Empty Data Frames

```{r}
event_data <- data.frame(matrix(ncol = 0, nrow = 0))
occurrence_data <- data.frame(matrix(ncol = 0, nrow = 0))
emof_data <- data.frame(matrix(ncol = 0, nrow = 0))
multimedia_data <- data.frame(matrix(ncol = 0, nrow = 0))
dnaderived_data <- data.frame(matrix(ncol = 0, nrow = 0))
```

## Create Parent Event Data

### NEON Project

```{r}
#I think sitecount is wrong - should be entire number of sites in dataset
NEON_fish_protocol_data <- data.frame(eventID = "NEON_fish",
                                      parentEventID = NA,
                                      eventType = "project",
                                      eventDate = paste("2019-07-01", Sys.Date(), sep = "/"),
                                      continent = "North America",
                                      country = "United States",
                                      siteCount = "81",
                                      siteNestingDescription = "81 field sites (47 terrestrial and 34 freshwater aquatic)",
                                      targetTaxonomicScope = "Osteichthyes",
                                      taxonCompletenessReported = "??",
                                      taxonCompletenessProtocols = "??",
                                      isTaxonomicScopeFullyReported = "true",
                                      isAbsenceReported = "false",
                                      hasNonTargetTaxa = "true",
                                      nonTargetTaxa = "Amphibia | Reptilia",
                                      areNonTargetTaxaFullyReported = "false",
                                      targetLifeStageScope = "larval | young of the year | juvenile | adult | gravid",
                                      excludedLifeStageScope = "egg",
                                      isLifeStageScopeFullyReported = "true",
                                      verbatimTargetScope = "freshwater fishes",
                                      compilationTypes = "samplingEvents",
                                      protocolNames = "electrofishing | gill netting | mini-fyke netting",
                                      protocolDescriptions = "Fish are sampled in two sampling bouts per year at lakes and wadeable stream sites, during spring and fall. Ten sampling reaches or segments are established at each site; with 3 fixed reaches sampled during every bout and a random subset of 3 additional reaches or segments selected for sampling each year. Fish are sampled using primarily electrofishing at both lakes and streams. Gill-nets and mini-fyke nets are additionally deployed in lake sites, once per segment per sampling bout.",
                                      protocolReferences = "Monahan, D. 2021. AOS Protocol and Procedure: FSL â€“ Fish Sampling in Lakes. NEON.DOC.001296. NEON (National Ecological Observatory Network). | Monahan, D. 2021. AOS Protocol and Procedure: FSS - Fish Sampling in Wadeable Streams. NEON.DOC.001295. NEON (National Ecological Observatory Network).",
                                      isAbundanceReported = "true",
                                      isAbundanceCapReported = "false",
                                      isLeastSpecificTargetCategoryQuantityInclusive = "true",
                                      hasVouchers = "true",
                                      voucherInstitutions = "Arizona State University Biocollections",
                                      hasMaterialSamples = "true",
                                      materialSampleTypes = "wholeOrganism | tissue",
                                      samplingPerformedBy = "NEON Field Staff",
                                      isSamplingEffortReported = "true",
                                      samplingEffortProtocol = "A five-day fish sampling period = 1 bout. Sampling bouts should not be longer than 5 days long assuming no weather or other unexpected schedule delays. Typically one bout can be managed by 2 staff. Person hours can be calculated from start times, end times and number of staff in a sampling pass."
                                    )
event_data <- rbind(event_data, NEON_fish_protocol_data)
```

### Site Data

<https://data.neonscience.org/api/v0/locations/BIGC>

```{r}
BIGC_data <- data.frame(eventID = "BIGC",
                        parentEventID = "NEON_fish",
                        eventType = "site",
                        eventDate = paste(min(fish.counts$fsh_fieldData$startDate, na.rm = TRUE), 
                                          max(fish.counts$fsh_fieldData$endDate, na.rm = TRUE),
                                          sep = "/"),
                        decimalLatitude = 37.059719,
                        decimalLongitude = -119.257549,
                        coordinateUncertaintyinMeters = 1000,
                        habitat = "Aquatic Wadeable Stream",
                        geodeticDatum = "WGS84",
                        continent = "North America",
                        country = "United States",
                        stateProvince = "California",
                        county = "Fresno County",
                        locality = "Pacific Southwest (D17), Upper Big Creek NEON (BIGC)",
                        minimumElevationInMeters = 1003,
                        maximumElevationInMeters = 1700,
                        siteCount = 10,
                        siteNestingDescription = "Aquatic stream site divided into 10 reaches",
                        verbatimSiteDescriptions = "A wadeable stream on the western slope of the Sierra Nevada Mountains | mixed mature cottonwood trees, short grasses, and shrubs | 1 km in length",
                        verbatimSiteNames = "BIGC | Upper Big Creek",
                        reportedWeather = "{\"minimumWinterTemperatureInDegreesFahrenheit\": 32,
                                            \"maximumWinterTemperatureInDegreesFahrenheit\": 48,
                                            \"maximumSummerTemperatureInDegreesFahrenheit\": 57,
                                            \"maximumSummerTemperatureInDegreesFahrenheit\": 68,
                                            \"annualMeanTemperatureInDegreesFahrenheit\": 56,
                                            \"annualPrecipitationInInches\": 34.5}"
                        
                        )
event_data <- merge(BIGC_data, event_data, all=TRUE)

```

## Map Fish Data

### Map fsh_fieldData

#### Reach Data
Contains data about the reach/segment itself (e.g., location, elevation, fixed/random, etc.)

```{r}
reach_data <- unique(fish.counts$fsh_fieldData[, c("namedLocation",
                                                   "siteID",
                                                   "decimalLatitude",
                                                   "decimalLongitude",
                                                   "coordinateUncertainty",
                                                   "elevation",
                                                   "elevationUncertainty",
                                                   "geodeticDatum",
                                                   "fixedRandomReach")])

reach_data$minimumElevation <- reach_data$elevation - reach_data$elevationUncertainty
reach_data$maximumElevation <- reach_data$elevation + reach_data$elevationUncertainty

added_reach_data <- data.frame(eventID = reach_data$namedLocation,
                               parentEventID = reach_data$siteID,
                               eventType = "reach",
                               eventDate = "XXXX",
                               decimalLatitude = reach_data$decimalLatitude,
                               decimalLongitude = reach_data$decimalLongitude,
                               coordinateUncertaintyinMeters = reach_data$coordinateUncertainty,
                               habitat = "XXX",
                               geodeticDatum = reach_data$geodeticDatum,
                               minimumElevationInMeters = reach_data$minimumElevation,
                               maximumElevationInMeters = reach_data$maximumElevation,
                               siteCount = ifelse(reach_data$fixedRandomReach == "fixed", 3, 1),
                               siteNestingDescription = ifelse(reach_data$fixedRandomReach == "fixed", "3 passes (replicates)", "1 pass (replicate)"),
                               verbatimSiteDescriptions = "~100m long reaches"
                               )

reach_mof_data <- data.frame(measurementID = "XXX",
                             eventID = reach_data$namedLocation,
                             measurementType = "Reach type (fixed or random)",
                             measurementValue = reach_data$fixedRandomReach)

event_data <- merge(added_reach_data, event_data, all=TRUE)
emof_data <- rbind(reach_mof_data, emof_data)

```

#### Reach Sampling Data
Contains data about the reach sampling event (e.g., date, condition, protocol, etc.)

```{r}
#?reach condition - kinda like weather
#?sampling protocol version
reach_sampling_data <- data.frame(eventID = fish.counts$fsh_fieldData$reachID,
                                  parentEventID = fish.counts$fsh_fieldData$namedLocation,
                                  eventType = "reach sampling",
                                  eventDate = as.character(fish.counts$fsh_fieldData$startDate),
                                  eventRemarks = fish.counts$fsh_fieldData$remarks,
                                  reportedExtremeConditions = fish.counts$fsh_fieldData$samplingImpractical,
                                  identifiedBy = fish.counts$fsh_fieldData$identifiedBy,
                                  protocolReferences = fish.counts$fsh_fieldData$samplingProtocolVersion,
                                  samplingPerformedBy = paste(fish.counts$fsh_fieldData$aCollectedBy, fish.counts$fsh_fieldData$bCollectedBy, fish.counts$fsh_fieldData$cCollectedBy, sep = ", "),
                                  habitat = fish.counts$fsh_fieldData$reachCondition
                                   )

reach_sampling_mof_data <- data.frame(measurementID = "XXX",
                                      eventID = fish.counts$fsh_fieldData$reachID,
                                      measurementType = "Measured reach length",
                                      measurementValue = fish.counts$fsh_fieldData$measuredReachLength,
                                      measurementUnit = "m")

event_data <- merge(reach_sampling_data, event_data, all=TRUE)
emof_data <- merge(reach_sampling_mof_data, emof_data, all=TRUE)
```


### Map fsh_perPass

```{r}

```

### Map fsh_perFish

```{r}

```

### Map fsh_bulkCount

```{r}

```

### Map fsh_invertBycatch

```{r}

```
